<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√úcret G√ºncelleme Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        button { background: linear-gradient(45deg, #007bff, #6f42c1); color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { opacity: 0.9; }
        .current-fee { background: #e9ecef; padding: 15px; border-radius: 4px; margin-bottom: 20px; font-size: 18px; font-weight: bold; }
        .error { color: #dc3545; margin-top: 10px; padding: 10px; background: #f8d7da; border-radius: 4px; }
        .success { color: #155724; margin-top: 10px; padding: 10px; background: #d4edda; border-radius: 4px; }
        .history-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .history-table th, .history-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .history-table th { background: #f8f9fa; }
        .loading { color: #6c757d; font-style: italic; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèãÔ∏è √úcret G√ºncelleme Sistemi</h1>
        
        <!-- Mevcut √úcret -->
        <div class="form-group">
            <label>Mevcut Aylƒ±k √úcret:</label>
            <div class="current-fee" id="currentFee">Y√ºkleniyor...</div>
        </div>

        <!-- Form -->
        <form id="feeUpdateForm">
            <div class="form-group">
                <label for="uyeId">√úye ID:</label>
                <input type="number" id="uyeId" name="uyeId" value="1" required>
            </div>

            <div class="form-group">
                <label for="yeniUcret">Yeni Aylƒ±k √úcret (‚Ç∫):</label>
                <input type="number" id="yeniUcret" name="yeniUcret" step="0.01" min="0" placeholder="√ñrn: 150.00" required>
            </div>

            <div class="form-group">
                <label for="artisNedeni">√úcret Artƒ±≈ü Nedeni:</label>
                <select id="artisNedeni" name="artisNedeni" required>
                    <option value="">Se√ßiniz...</option>
                </select>
            </div>

            <div class="form-group">
                <label for="aciklama">A√ßƒ±klama:</label>
                <textarea id="aciklama" name="aciklama" rows="3" placeholder="√úcret artƒ±≈üƒ± hakkƒ±nda detaylƒ± a√ßƒ±klama..."></textarea>
            </div>

            <div class="form-group">
                <label for="gecerlilikTarihi">Ge√ßerlilik Tarihi:</label>
                <input type="date" id="gecerlilikTarihi" name="gecerlilikTarihi" required>
            </div>

            <button type="submit">üí≥ √úcreti G√ºncelle</button>
        </form>

        <!-- Mesajlar -->
        <div id="message"></div>

        <!-- √úcret Ge√ßmi≈üi -->
        <h3>üìä √úcret Ge√ßmi≈üi</h3>
        <div id="historyContent" class="loading">Y√ºkleniyor...</div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:7043/api/Ucret';

        // Sayfa y√ºklendiƒüinde
        document.addEventListener('DOMContentLoaded', function() {
            loadArtisNedenleri();
            loadCurrentFee();
            loadFeeHistory();
            
            // Bug√ºn√ºn tarihini ayarla
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('gecerlilikTarihi').value = today;
        });

        // Artƒ±≈ü nedenlerini y√ºkle
        async function loadArtisNedenleri() {
            try {
                const response = await fetch(`${API_BASE_URL}/artis-nedenleri`);
                if (!response.ok) throw new Error('API yanƒ±t vermedi');
                
                const nedenler = await response.json();
                const select = document.getElementById('artisNedeni');
                
                nedenler.forEach(neden => {
                    const option = document.createElement('option');
                    option.value = neden;
                    option.textContent = neden;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Artƒ±≈ü nedenleri y√ºklenemedi:', error);
                showMessage('‚ùå API baƒülantƒ±sƒ± kurulamadƒ±. L√ºtfen API\'nin √ßalƒ±≈ütƒ±ƒüƒ±ndan emin olun.', 'error');
            }
        }

        // Mevcut √ºcreti y√ºkle
        async function loadCurrentFee() {
            try {
                const uyeId = document.getElementById('uyeId').value;
                const response = await fetch(`${API_BASE_URL}/uye/${uyeId}/mevcut`);
                if (!response.ok) throw new Error('√úye bulunamadƒ±');
                
                const ucret = await response.json();
                document.getElementById('currentFee').textContent = `${ucret} ‚Ç∫`;
            } catch (error) {
                console.error('Mevcut √ºcret y√ºklenemedi:', error);
                document.getElementById('currentFee').textContent = '‚ùå Y√ºklenemedi';
            }
        }

        // √úcret ge√ßmi≈üini y√ºkle
        async function loadFeeHistory() {
            try {
                const uyeId = document.getElementById('uyeId').value;
                const response = await fetch(`${API_BASE_URL}/uye/${uyeId}`);
                if (!response.ok) throw new Error('Ge√ßmi≈ü y√ºklenemedi');
                
                const gecmis = await response.json();
                const historyContent = document.getElementById('historyContent');
                
                if (gecmis.length === 0) {
                    historyContent.innerHTML = '<p>üìù Hen√ºz √ºcret g√ºncellemesi yapƒ±lmamƒ±≈ü.</p>';
                    return;
                }

                let html = '<table class="history-table">';
                html += '<tr><th>Tarih</th><th>Eski √úcret</th><th>Yeni √úcret</th><th>Neden</th><th>A√ßƒ±klama</th></tr>';
                
                gecmis.forEach(kayit => {
                    html += `<tr>
                        <td>${new Date(kayit.guncellemeTarihi).toLocaleDateString('tr-TR')}</td>
                        <td>${kayit.eskiUcret} ‚Ç∫</td>
                        <td>${kayit.yeniUcret} ‚Ç∫</td>
                        <td>${kayit.artisNedeni}</td>
                        <td>${kayit.aciklama || '-'}</td>
                    </tr>`;
                });
                
                html += '</table>';
                historyContent.innerHTML = html;
            } catch (error) {
                console.error('√úcret ge√ßmi≈üi y√ºklenemedi:', error);
                document.getElementById('historyContent').innerHTML = '<p>‚ùå Ge√ßmi≈ü y√ºklenemedi</p>';
            }
        }

        // Form submit
        document.getElementById('feeUpdateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                uyeId: parseInt(document.getElementById('uyeId').value),
                yeniUcret: parseFloat(document.getElementById('yeniUcret').value),
                artisNedeni: document.getElementById('artisNedeni').value,
                aciklama: document.getElementById('aciklama').value,
                gecerlilikTarihi: document.getElementById('gecerlilikTarihi').value + 'T00:00:00'
            };

            try {
                const response = await fetch(`${API_BASE_URL}/guncelle`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showMessage('‚úÖ √úcret ba≈üarƒ±yla g√ºncellendi!', 'success');
                    
                    // Formu temizle
                    document.getElementById('yeniUcret').value = '';
                    document.getElementById('artisNedeni').value = '';
                    document.getElementById('aciklama').value = '';
                    document.getElementById('gecerlilikTarihi').value = new Date().toISOString().split('T')[0];
                    
                    // Verileri yenile
                    loadCurrentFee();
                    loadFeeHistory();
                } else {
                    const error = await response.text();
                    showMessage(`‚ùå Hata: ${error}`, 'error');
                }
            } catch (error) {
                console.error('√úcret g√ºncelleme hatasƒ±:', error);
                showMessage('‚ùå √úcret g√ºncellenirken bir hata olu≈ütu', 'error');
            }
        });

        // √úye ID deƒüi≈ütiƒüinde
        document.getElementById('uyeId').addEventListener('change', function() {
            loadCurrentFee();
            loadFeeHistory();
        });

        // Mesaj g√∂ster
        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = message;
            messageDiv.className = type;
            
            setTimeout(() => {
                messageDiv.textContent = '';
                messageDiv.className = '';
            }, 5000);
        }
    </script>
</body>
</html>
